name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'apply'
        type: choice
        options:
          - apply
          - destroy

jobs:
  terraform:
    runs-on: ubuntu-latest
    environment: myenv
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/1037056803639/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-actions-sa@cloudcomputing-473914.iam.gserviceaccount.com'
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Get GitHub Runner IP
        id: runner-ip
        run: |
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "ip=${RUNNER_IP}" >> $GITHUB_OUTPUT
          echo "GitHub Runner IP: ${RUNNER_IP}"
      
      - name: Setup SSH Keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/gcp-vm-key
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/gcp-vm-key.pub
          chmod 600 ~/.ssh/gcp-vm-key
          chmod 644 ~/.ssh/gcp-vm-key.pub
      
      - name: Install jinja2-cli
        run: |
          pip install jinja2-cli
      
      - name: Generate Terraform tfvars from Jinja template
        working-directory: ./Deployment/test
        run: |
          if ls *.jinja >/dev/null 2>&1; then
            for f in *.jinja; do
              jinja2 "$f" -D ansible_ip="${{ steps.runner-ip.outputs.ip }}" > "./$(basename "$f" .jinja).tfvars"
            done
          fi
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
      
      - name: Terraform Init
        working-directory: ./Deployment/test
        run: terraform init
      
      - name: Terraform Plan
        if: github.event.inputs.action == 'apply'
        working-directory: ./Deployment/test
        env:
          TF_VAR_ssh_key: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          terraform plan -var-file="config.auto.tfvars"
      
      - name: Terraform Apply
        if: github.event.inputs.action == 'apply'
        working-directory: ./Deployment/test
        env:
          TF_VAR_ssh_key: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          terraform apply -auto-approve -var-file="config.auto.tfvars"
      
      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        working-directory: ./Deployment/test
        env:
          TF_VAR_ssh_key: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          terraform destroy -auto-approve -var-file="config.auto.tfvars"
      
      - name: Wait for VMs to be ready
        if: github.event.inputs.action == 'apply'
        run: sleep 30
      
      - name: Install Ansible
        if: github.event.inputs.action == 'apply'
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible
      
      - name: Setup Ansible Configuration
        if: github.event.inputs.action == 'apply'
        working-directory: ./Deployment/test
        run: |
          cat > ansible.cfg << EOF
          [defaults]
          host_key_checking = False
          inventory = inventory.ini
          private_key_file = ~/.ssh/gcp-vm-key
          EOF
      
      - name: Clean SSH known hosts
        if: github.event.inputs.action == 'apply'
        working-directory: ./Deployment/test
        run: |
          if [ -f inventory.ini ]; then
            grep -oP '^\d+\.\d+\.\d+\.\d+' inventory.ini | while read ip; do
              ssh-keygen -R "$ip" 2>/dev/null || true
            done
          fi
      
      - name: Test Ansible connectivity
        if: github.event.inputs.action == 'apply'
        working-directory: ./Deployment/test
        run: ansible all -m ping
      
      - name: Run Ansible Playbook
        if: github.event.inputs.action == 'apply'
        working-directory: ./Deployment/test
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: ansible-playbook Ansible/main.yml -e "jwt_secret=$JWT_SECRET"
      
      - name: Get Application URLs
        if: github.event.inputs.action == 'apply'
        working-directory: ./Deployment/test
        run: |
          DB_IP=$(ansible db_vm --list-hosts | tail -1 | tr -d ' ')
          APP_IP=$(ansible gcp_vm --list-hosts | tail -1 | tr -d ' ')
          echo "### Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Database:** \`mongosh mongodb://${DB_IP}:27017\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application:** http://${APP_IP}:3001" >> $GITHUB_STEP_SUMMARY
          
          curl -f http://${APP_IP}:3001/ || echo "App health check failed"