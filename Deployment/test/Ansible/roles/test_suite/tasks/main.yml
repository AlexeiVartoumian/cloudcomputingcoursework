---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
    
- name: Install Golang
  ansible.builtin.apt:
    name: 
      - golang-go
    state: present


- name: Clone Test suite Repo
  ansible.builtin.git:
    repo: "https://github.com/AlexeiVartoumian/cloudcomputingcoursework.git"
    version: master
    dest: "/tmp/tests"
  become_user: ubuntu

- name: Copy Testing Framework to home directory
  copy:
    src: /tmp/tests/TestingFramework/
    dest: /home/ubuntu/TestingFramework/
    remote_src: yes
  become_user: ubuntu


- name: Remove cloned repo
  file:
    path: /tmp/tests/
    state: absent
  become_user: ubuntu

- name: Fix go.mod version format
  replace:
    path: /home/ubuntu/TestingFramework/suite/go.mod
    regexp: '^go 1\.23\.4$'
    replace: 'go 1.23'
  become_user: ubuntu

- name: Install go dependencies
  shell: go mod download
  args:
    chdir: /home/ubuntu/TestingFramework/suite



- name: Run tests
  shell: go test -v
  args:
    chdir: /home/ubuntu/TestingFramework/suite
  environment:
    MONGO_URI: "mongodb://{{ groups['db_vm'][0] }}:27017"
    APP_IP: "http://{{ groups['gcp_vm'][0] }}:3001"
  become_user: ubuntu
  register: test_results

- name: Display test results
  debug:
    var: test_results.stdout_lines
  
  
